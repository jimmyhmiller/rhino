name: Update Compatibility Table

on:
  push:
    branches:
      - latest
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-compat:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Rhino
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'adopt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Rhino JAR
        run: ./gradlew :rhino-all:shadowJar

      - name: Find built JAR
        id: find-jar
        run: |
          JAR_PATH=$(find rhino-all/build/libs -name "rhino-all-*.jar" | head -1)
          echo "jar_path=$(realpath $JAR_PATH)" >> $GITHUB_OUTPUT
          VERSION=$(basename "$JAR_PATH" .jar | sed 's/rhino-all-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH (version: $VERSION)"

      - name: Clone node-compat-table
        run: |
          git clone -b gh-pages --depth 1 https://github.com/gbrail/node-compat-table.git
          cd node-compat-table
          npm install

      - name: Build upstream mozilla/rhino master
        run: |
          git clone --depth 1 https://github.com/mozilla/rhino.git upstream-rhino
          cd upstream-rhino
          ./gradlew :rhino-all:shadowJar
          UPSTREAM_JAR=$(find rhino-all/build/libs -name "rhino-all-*.jar" | head -1)
          echo "UPSTREAM_JAR=$(realpath $UPSTREAM_JAR)" >> $GITHUB_ENV
          UPSTREAM_VERSION=$(basename "$UPSTREAM_JAR" .jar | sed 's/rhino-all-//')
          echo "UPSTREAM_VERSION=$UPSTREAM_VERSION" >> $GITHUB_ENV
          echo "Built upstream: $UPSTREAM_JAR (version: $UPSTREAM_VERSION)"

      - name: Run compatibility tests
        run: |
          cd node-compat-table

          JAR_PATH="${{ steps.find-jar.outputs.jar_path }}"
          VERSION="${{ steps.find-jar.outputs.version }}"

          echo "Testing Rhino $VERSION from $JAR_PATH"

          # Download test data from kangax/compat-table
          curl -s -o data-es6.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-es6.js"
          curl -s -o data-es2016plus.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-es2016plus.js"
          curl -s -o data-esnext.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-esnext.js"

          # Extract testers
          node extract.js ./data-es6.js > testers-es6.json
          node extract.js ./data-es2016plus.js > testers-es2016plus.json
          node extract.js ./data-esnext.js > testers-esnext.json
          node testers.js > testers.json

          # Create results directory
          mkdir -p rhino-results

          # Function to run tests for a JAR
          run_tests() {
            local jar="$1"
            local ver="$2"
            echo "Testing $ver..."

            # Run tests without ES6 flag
            java -jar "$jar" -version 200 rhinotest.js 2>/dev/null > rhino-results/${ver}.json || echo '{}' > rhino-results/${ver}.json

            # Run tests with ES6 flag
            echo "var defined = 'RHINO_VERSION_ES6';" > /tmp/test.js
            java -jar "$jar" -version 200 /tmp/test.js rhinotest.js 2>/dev/null > rhino-results/${ver}-es6.json || echo '{}' > rhino-results/${ver}-es6.json
            rm -f /tmp/test.js
          }

          # Test upstream mozilla/rhino master
          run_tests "$UPSTREAM_JAR" "$UPSTREAM_VERSION"

          # Test this fork's latest branch
          run_tests "$JAR_PATH" "${VERSION}-fork"

      - name: Build HTML
        run: |
          cd node-compat-table

          VERSION="${{ steps.find-jar.outputs.version }}"

          # Update rhinoversions.js to include tested versions (must be object with flagged property)
          echo "module.exports = {" > rhinoversions.js
          echo "  '$UPSTREAM_VERSION': { flagged: true }," >> rhinoversions.js
          echo "  '${VERSION}-fork': { flagged: true }" >> rhinoversions.js
          echo "};" >> rhinoversions.js

          cat rhinoversions.js

          # Build the HTML
          node buildrhino.js

      - name: Prepare site
        run: |
          mkdir -p _site/compat
          cp node-compat-table/index.html _site/compat/engines.html
          cp node-compat-table/style.css _site/compat/style.css
          cp node-compat-table/favico.ico _site/compat/favico.ico 2>/dev/null || true
          cat > _site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Rhino Fork</title>
            <meta http-equiv="refresh" content="0; url=compat/engines.html">
          </head>
          <body>
            <p>Redirecting to <a href="compat/engines.html">compatibility table</a>...</p>
          </body>
          </html>
          EOF

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-compat
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
