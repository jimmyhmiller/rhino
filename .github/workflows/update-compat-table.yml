name: Update Compatibility Table

on:
  push:
    branches:
      - latest

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build-compat:
    runs-on: ubuntu-latest
    steps:
      - name: Check out Rhino
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'adopt'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build Rhino JAR
        run: ./gradlew :rhino-all:shadowJar

      - name: Find built JAR
        id: find-jar
        run: |
          JAR_PATH=$(find rhino-all/build/libs -name "rhino-all-*.jar" | head -1)
          echo "jar_path=$(realpath $JAR_PATH)" >> $GITHUB_OUTPUT
          VERSION=$(basename "$JAR_PATH" .jar | sed 's/rhino-all-//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found JAR: $JAR_PATH (version: $VERSION)"

      - name: Clone node-compat-table
        run: |
          git clone -b gh-pages --depth 1 https://github.com/gbrail/node-compat-table.git
          cd node-compat-table
          npm install

      - name: Build upstream mozilla/rhino master
        run: |
          git clone --depth 1 https://github.com/mozilla/rhino.git build/upstream-rhino
          cd build/upstream-rhino

          # Apply flush fix to upstream - JLine's dumb terminal buffers output without flushing
          # Without this fix, print() output is lost in non-interactive mode with shadowJar
          GLOBAL_FILE="rhino-tools/src/main/java/org/mozilla/javascript/tools/shell/Global.java"
          sed -i 's/        return Context.getUndefinedValue();/        c.flush();\n        return Context.getUndefinedValue();/' "$GLOBAL_FILE"

          echo "=== Verifying patch applied ==="
          grep -n "c.flush" "$GLOBAL_FILE"

          ./gradlew :rhino-all:shadowJar
          UPSTREAM_JAR=$(find rhino-all/build/libs -name "rhino-all-*.jar" | head -1)
          echo "UPSTREAM_JAR=$(realpath $UPSTREAM_JAR)" >> $GITHUB_ENV
          UPSTREAM_VERSION=$(basename "$UPSTREAM_JAR" .jar | sed 's/rhino-all-//')
          echo "UPSTREAM_VERSION=$UPSTREAM_VERSION" >> $GITHUB_ENV
          echo "Built upstream: $UPSTREAM_JAR (version: $UPSTREAM_VERSION)"

      - name: Run compatibility tests
        run: |
          cd node-compat-table

          JAR_PATH="${{ steps.find-jar.outputs.jar_path }}"
          VERSION="${{ steps.find-jar.outputs.version }}"

          echo "Testing Rhino $VERSION from $JAR_PATH"

          # Download test data from kangax/compat-table
          curl -s -o data-es6.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-es6.js"
          curl -s -o data-es2016plus.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-es2016plus.js"
          curl -s -o data-esnext.js "https://raw.githubusercontent.com/kangax/compat-table/gh-pages/data-esnext.js"

          # Extract testers
          node extract.js ./data-es6.js > testers-es6.json
          node extract.js ./data-es2016plus.js > testers-es2016plus.json
          node extract.js ./data-esnext.js > testers-esnext.json
          node testers.js > testers.json

          # Create results directory
          mkdir -p rhino-results

          # Function to run tests for a JAR
          run_tests() {
            local jar="$1"
            local ver="$2"
            echo "Testing $ver with JAR: $jar"

            # Verify JAR exists
            if [ ! -f "$jar" ]; then
              echo "ERROR: JAR file not found: $jar"
              echo '{}' > rhino-results/${ver}.json
              echo '{}' > rhino-results/${ver}-es6.json
              return 1
            fi

            # Run tests without ES6 flag (use load() as original script does)
            echo "supportVersion=200; load('rhinotest.js');" > /tmp/test.js
            echo "Running: java -jar $jar -version 200 /tmp/test.js"
            if ! java -jar "$jar" -version 200 /tmp/test.js > /tmp/rhino-out.log 2>/tmp/rhino-err.log; then
              echo "ERROR: Test failed for $ver (exit code: $?)"
              echo "=== stdout output (first 1000 chars) ==="
              head -c 1000 /tmp/rhino-out.log
              echo ""
              echo "=== stderr output ==="
              cat /tmp/rhino-err.log
              echo "=== end ==="
              echo '{}' > rhino-results/${ver}.json
            else
              cp /tmp/rhino-out.log rhino-results/${ver}.json
            fi

            # Run tests with ES6 flag
            echo "var defined = 'RHINO_VERSION_ES6'; supportVersion=200; load('rhinotest.js');" > /tmp/test.js
            echo "Running ES6: java -jar $jar -version 200 /tmp/test.js"
            if ! java -jar "$jar" -version 200 /tmp/test.js > /tmp/rhino-out.log 2>/tmp/rhino-err.log; then
              echo "ERROR: ES6 test failed for $ver (exit code: $?)"
              echo "=== stdout output (first 1000 chars) ==="
              head -c 1000 /tmp/rhino-out.log
              echo ""
              echo "=== stderr output ==="
              cat /tmp/rhino-err.log
              echo "=== end ==="
              echo '{}' > rhino-results/${ver}-es6.json
            else
              cp /tmp/rhino-out.log rhino-results/${ver}-es6.json
            fi
            rm -f /tmp/test.js /tmp/rhino-err.log /tmp/rhino-out.log

            # Ensure files have valid JSON
            for f in rhino-results/${ver}.json rhino-results/${ver}-es6.json; do
              if [ ! -s "$f" ] || ! node -e "JSON.parse(require('fs').readFileSync('$f'))" 2>/dev/null; then
                echo "Warning: Invalid JSON in $f (size: $(wc -c < "$f") bytes)"
                echo "=== First 500 chars of $f ==="
                head -c 500 "$f"
                echo ""
                echo "=== end ==="
                echo '{}' > "$f"
              fi
            done
          }

          # Test upstream mozilla/rhino master
          run_tests "$UPSTREAM_JAR" "$UPSTREAM_VERSION"

          # Test this fork's latest branch
          run_tests "$JAR_PATH" "${VERSION}-fork"

      - name: Build HTML
        run: |
          cd node-compat-table

          VERSION="${{ steps.find-jar.outputs.version }}"

          echo "=== Debug info ==="
          echo "UPSTREAM_VERSION: $UPSTREAM_VERSION"
          echo "VERSION: $VERSION"
          echo "=== Files in rhino-results ==="
          ls -la rhino-results/
          echo "=== Sample result content ==="
          head -20 rhino-results/*.json || true

          # Update rhinoversions.js to include tested versions (must be object with flagged property)
          echo "module.exports = {" > rhinoversions.js
          echo "  '$UPSTREAM_VERSION': { flagged: true }," >> rhinoversions.js
          echo "  '${VERSION}-fork': { flagged: true }" >> rhinoversions.js
          echo "};" >> rhinoversions.js

          cat rhinoversions.js

          # Build the HTML
          node buildrhino.js

      - name: Prepare compat site
        run: |
          mkdir -p build/_site/compat
          cp node-compat-table/index.html build/_site/compat/engines.html
          cp node-compat-table/style.css build/_site/compat/style.css
          cp node-compat-table/favico.ico build/_site/compat/favico.ico 2>/dev/null || true

      - name: Upload compat artifact
        uses: actions/upload-artifact@v4
        with:
          name: compat-site
          path: build/_site/

  # Run test262 for fork (runs in parallel with build-test262-upstream)
  build-test262-fork:
    runs-on: ubuntu-latest
    steps:
      - name: Check out fork with test262 submodule
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'adopt'

      - name: Build fork
        run: ./gradlew build -x test

      - name: Run test262 for fork
        run: |
          echo "Running test262 for fork with $(nproc) threads..."
          ./gradlew :tests:test262Json \
            -Pengine=rhino-fork \
            -Poutput=$GITHUB_WORKSPACE/build/test262-fork \
            -Ptest262path=test262 \
            -Pthreads=$(nproc) || true
          echo "Fork test262 complete"
          ls -la $GITHUB_WORKSPACE/build/test262-fork/ || echo "No output directory!"

      - name: Upload fork test262 results
        uses: actions/upload-artifact@v4
        with:
          name: test262-fork-results
          path: build/test262-fork/

  # Run test262 for upstream (runs in parallel with build-test262-fork)
  build-test262-upstream:
    runs-on: ubuntu-latest
    steps:
      - name: Check out fork (for scripts and Test262JsonRunner)
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'adopt'

      - name: Clone and build upstream mozilla/rhino
        run: |
          git clone --depth 1 --recurse-submodules --shallow-submodules https://github.com/mozilla/rhino.git build/upstream-rhino
          cd build/upstream-rhino

          # Verify test262 submodule was cloned
          if [ ! -d "tests/test262/test" ]; then
            echo "Warning: test262 submodule not found, trying manual init..."
            git submodule update --init --depth 1 tests/test262
          fi

          echo "test262 directory contents:"
          ls -la tests/test262/ || echo "test262 directory missing!"

          ./gradlew build -x test
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "UPSTREAM_VERSION=$VERSION" >> $GITHUB_ENV
          echo "Built upstream version: $VERSION"

          # Copy the Test262JsonRunner and gradle task from fork to upstream
          cp ../../tests/src/test/java/org/mozilla/javascript/tests/Test262JsonRunner.java \
             tests/src/test/java/org/mozilla/javascript/tests/

          # Check if snakeyaml dependency exists, add it if not
          if ! grep -q "snakeyaml" tests/build.gradle; then
            sed -i '/testImplementation.*junit/a\    testImplementation "org.yaml:snakeyaml:2.5"' tests/build.gradle
          fi

          # Append the test262Json task to upstream's build.gradle
          cat ../../.github/scripts/test262json-task.gradle >> tests/build.gradle

          # Rebuild with the new file
          ./gradlew :tests:compileTestJava

      - name: Run test262 for upstream
        run: |
          cd build/upstream-rhino
          echo "Running test262 for upstream with $(nproc) threads..."
          ./gradlew :tests:test262Json \
            -Pengine=rhino-upstream \
            -Poutput=$GITHUB_WORKSPACE/build/test262-upstream \
            -Ptest262path=test262 \
            -Pthreads=$(nproc) || true
          echo "Upstream test262 complete"
          ls -la $GITHUB_WORKSPACE/build/test262-upstream/ || echo "No output directory!"

      - name: Upload upstream test262 results
        uses: actions/upload-artifact@v4
        with:
          name: test262-upstream-results
          path: build/test262-upstream/

  # Run test262 for QuickJS (runs in parallel with Rhino tests)
  build-test262-quickjs:
    runs-on: ubuntu-latest
    steps:
      - name: Check out fork (for scripts and test262)
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build QuickJS from source
        run: |
          # Build QuickJS from source to get run-test262 binary
          # This matches the methodology used by test262.fyi
          # See: https://github.com/test262-fyi/data/tree/main/engines/qjs
          git clone --depth=1 https://github.com/bellard/quickjs.git /tmp/quickjs
          cd /tmp/quickjs
          make -j$(nproc)
          # Copy run-test262 binary (the special test262 runner, not regular qjs)
          cp run-test262 $GITHUB_WORKSPACE/qjs
          cd $GITHUB_WORKSPACE
          ./qjs --help || true
          echo "QuickJS run-test262 binary ready"

      - name: Run test262 for QuickJS
        run: |
          node .github/scripts/run-test262-engine.js \
            --engine ./qjs \
            --test262 tests/test262 \
            --output $GITHUB_WORKSPACE/build/test262-quickjs \
            --name quickjs

      - name: Generate features and editions for QuickJS
        run: |
          node .github/scripts/generate-features-editions.js \
            build/test262-quickjs \
            tests/test262 \
            --engine quickjs \
            --output build/test262-quickjs

      - name: Upload QuickJS test262 results
        uses: actions/upload-artifact@v4
        with:
          name: test262-quickjs-results
          path: build/test262-quickjs/

  # Merge test262 results from all engine jobs
  build-test262:
    runs-on: ubuntu-latest
    needs: [build-test262-fork, build-test262-upstream, build-test262-quickjs]
    steps:
      - name: Check out fork (for scripts)
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Download fork results
        uses: actions/download-artifact@v4
        with:
          name: test262-fork-results
          path: build/test262-fork/

      - name: Download upstream results
        uses: actions/download-artifact@v4
        with:
          name: test262-upstream-results
          path: build/test262-upstream/

      - name: Download QuickJS results
        uses: actions/download-artifact@v4
        with:
          name: test262-quickjs-results
          path: build/test262-quickjs/

      - name: Generate features and editions data
        run: |
          # Generate features.json and editions.json for upstream
          node .github/scripts/generate-features-editions.js \
            build/test262-upstream \
            tests/test262 \
            --engine rhino-upstream \
            --output build/test262-upstream

          # Generate features.json and editions.json for fork
          node .github/scripts/generate-features-editions.js \
            build/test262-fork \
            tests/test262 \
            --engine rhino-fork \
            --output build/test262-fork

          # QuickJS features.json and editions.json are generated by its own job

      - name: Merge test262 results
        run: |
          # Build merge command with available engines
          MERGE_ARGS="rhino-upstream:build/test262-upstream rhino-fork:build/test262-fork"

          # Add QuickJS if results exist and are valid
          if [ -f build/test262-quickjs/index.json ]; then
            QUICKJS_TOTAL=$(node -e "console.log(JSON.parse(require('fs').readFileSync('build/test262-quickjs/index.json')).total || 0)")
            if [ "$QUICKJS_TOTAL" -gt 0 ]; then
              MERGE_ARGS="$MERGE_ARGS quickjs:build/test262-quickjs"
              echo "Including QuickJS results (total: $QUICKJS_TOTAL tests)"
            else
              echo "Skipping QuickJS (no valid results)"
            fi
          fi

          node .github/scripts/merge-test262-results.js \
            $MERGE_ARGS \
            --output build/test262-merged

      - name: Prepare test262 frontend
        run: |
          chmod +x .github/scripts/prepare-test262-frontend.sh
          .github/scripts/prepare-test262-frontend.sh build/_site/test262 build/test262-merged

      - name: Upload test262 artifact
        uses: actions/upload-artifact@v4
        with:
          name: test262-site
          path: build/_site/

  combine-and-deploy:
    runs-on: ubuntu-latest
    needs: [build-compat, build-test262]
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download compat artifact
        uses: actions/download-artifact@v4
        with:
          name: compat-site
          path: build/_site/

      - name: Download test262 artifact
        uses: actions/download-artifact@v4
        with:
          name: test262-site
          path: build/_site-test262/

      - name: Merge sites
        run: |
          # Copy test262 directory from test262 artifact
          cp -r build/_site-test262/test262 build/_site/ || true

          # Create main index page
          cat > build/_site/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Rhino Fork</title>
            <style>
              body { font-family: sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; }
              h1 { color: #333; }
              ul { list-style: none; padding: 0; }
              li { margin: 10px 0; }
              a { color: #0366d6; text-decoration: none; font-size: 18px; }
              a:hover { text-decoration: underline; }
              .description { color: #666; font-size: 14px; margin-left: 10px; }
            </style>
          </head>
          <body>
            <h1>Rhino Fork</h1>
            <p>Compatibility and conformance testing for the Rhino JavaScript engine fork.</p>
            <ul>
              <li>
                <a href="compat/engines.html">ECMAScript Compatibility Table</a>
                <span class="description">- kangax/compat-table based feature comparison</span>
              </li>
              <li>
                <a href="test262/">Test262 Conformance</a>
                <span class="description">- ECMA-262 specification conformance tests</span>
              </li>
            </ul>
          </body>
          </html>
          EOF

          echo "=== Site structure ==="
          find build/_site -type f | head -50

      - name: Upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
